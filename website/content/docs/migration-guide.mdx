---
description: >-
  This page containes a guide to migrate from Hashicorp Vault to OpenBao
---

# Migration guide

This page contains a guide to migrate a Hashicorp Vault cluster to Openbao.

:::info

This guide assumes in-place upgrade, that is, OpenBao will replace the
Vault server process on all nodes. All configuration, including
all endpoints and URLs will remain unchanged.

OpenBao API should be compatible with Vault to the extent that existing
clients should not even register a difference.

Some clients/service might have to be restarted.

:::

## Constraints

 * Vault version 1.14.1 (OSS)
 * OpenBao version 2.2.0
 * Raft storage
 * Shamir unseal (no auto-unseal)

Previous (and future) OpenBao versions will probably work fine. However,
this guide was tested with OpenBao 2.2.0 with Shamir unseal.

Only the OSS/BUSL version of Vault was tested, not Vault Enterprise.

## Limitations

If your Vault version is lower than 1.14.1, upgrade to v1.14.1.

If your Vault has been bootstrapped with Vault version < 1.3,
you may need to rekey. Vault pre 1.3 used a different Shamir seals
implementation which has been [removed](https://github.com/openbao/openbao/commit/ad0870c7361807192bfa1fc32964d8b1bca416ab)
from OpenBao.

## Known issues

Check [known-issues](https://openbao.org/docs/known-issues/) documentation
to get familiar with currently known problems and issues of the latest
release.

## Preparation

### Backup

Make a backup of your data! A [raft snapshot](https://openbao.org/docs/commands/operator/raft/#snapshot)
will do. So will a filesystem snapshot so long as your filesystem supports
atomic snapshots (like ZFS or BTRFS).

### Install and configure OpenBao

Make sure to have OpenBao [installed](https://openbao.org/docs/install/) and
[configured](https://openbao.org/docs/configuration/), _but not started_
on your nodes. The configuration is largely compatible.

It is recommended to use different storage path for the OpenBao instance.
The nodes will pull the data from the cluster when joining, there is no
need to reuse existing data. This also has the added benefit that a rollback
is slightly easier in case it's needed.

:::warning

If you use Vault `audit file` backend, you need to make sure OpenBao
can write to the existing file. In most cases this means something
like `chown openbao:openbao vault_audit_log.log`. You need to do this
_after_ you stop the Vault instance a node.
 
:::

If you have `disable_mlock` in your Vault config, remove it. OpenBao does
not use `mlock` [since 2.0.0](https://openbao.org/docs/rfcs/mlock-removal/).


### Upgrade the cluster

:::info

In this guide we do not rely on [Autopilot](https://openbao.org/docs/commands/operator/raft/#autopilot)

:::

Make a note of which node is the _leader_:
```
$ vault status

Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  false
...
Active Node Address     https://vault-03.example.com:8200
...
```

or

```
curl https://vault.example.com:8200/v1/sys/leader
```

**One by one**, upgrade the _follower_ nodes first.

1. stop Vault service
2. start OpenBao service
3. join the node to the cluster
   ```
   $ bao operator raft join vault-03.example.com:8200
   ```
4. unseal the node
   ```
   $ bao operator unseal
   ```
5. wait until the node becomes a voter (Voter field is `true`)
   Assuming you just joined node `vault-04`:
   ```
   $ bao operator raft list-peers
   
   Node        Address                         State       Voter
   ----        -------                         -----       -----
   ...
   vault-04    172.17.13.4:8201                follower    false
   ...
   ```

Repeat for for all _follower_ nodes.

Once all _followers_ run OpenBao, upgrade the _leader_.

```
VAULT_ADDR=https://vault-03.example.com:8200 vault operator step-down
```

Make sure the cluster elected a new leader:
```
$ vault status

Key                     Value
---                     -----
Seal Type               shamir
Initialized             true
Sealed                  false
...
Active Node Address     https://vault-01.example.com:8200
...
```

Repeat steps 1 through 5 above on the former leader, except in step 3
use the current leader address.

